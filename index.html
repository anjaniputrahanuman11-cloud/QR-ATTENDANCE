
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR Attendance System</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- React & Babel for in-browser JSX transpilation -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Custom CSS from the original App.tsx */
        .btn-primary { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1.5rem; border-radius: 0.5rem; background-image: linear-gradient(to right, #4f46e5, #7c3aed); color: white; font-weight: 600; border: none; cursor: pointer; transition: all 0.2s ease-in-out; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 7px 10px rgba(0, 0, 0, 0.1); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-secondary { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1.5rem; border-radius: 0.5rem; background-color: #e5e7eb; color: #374151; font-weight: 600; border: 1px solid #d1d5db; cursor: pointer; transition: all 0.2s ease-in-out; }
        .btn-secondary:hover { background-color: #d1d5db; }
        .btn-danger { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1.5rem; border-radius: 0.5rem; background-color: #ef4444; color: white; font-weight: 600; border: none; cursor: pointer; transition: all 0.2s ease-in-out; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .btn-danger:hover { background-color: #dc2626; transform: translateY(-2px); box-shadow: 0 7px 10px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // De-structure React hooks for easier use
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // --- All Components in one place ---

        // --- From components/Icons.tsx ---
        const QrCodeIcon = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M3.75 4.5a.75.75 0 00-1.5 0v1.5h1.5V4.5zM3.75 9a.75.75 0 00-1.5 0v1.5h1.5V9zM3.75 13.5a.75.75 0 00-1.5 0v1.5h1.5v-1.5zM9.75 4.5a.75.75 0 00-1.5 0v1.5h1.5V4.5zM9.75 9a.75.75 0 00-1.5 0v1.5h1.5V9zM9.75 13.5a.75.75 0 00-1.5 0v1.5h1.5v-1.5zM15.75 4.5a.75.75 0 00-1.5 0v1.5h1.5V4.5zM15.75 9a.75.75 0 00-1.5 0v1.5h1.5V9zM15.75 13.5a.75.75 0 00-1.5 0v1.5h1.5v-1.5zM4.5 3.75h1.5v-1.5a.75.75 0 00-1.5 0v1.5zM9 3.75h1.5v-1.5a.75.75 0 00-1.5 0v1.5zM13.5 3.75h1.5v-1.5a.75.75 0 00-1.5 0v1.5z" />
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 9.75h10.5v10.5H9z" />
            </svg>
        );
        const CameraIcon = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.776 48.776 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" />
                <path strokeLinecap="round" strokeLinejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" />
            </svg>
        );
        const StopIcon = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M5.25 7.5A2.25 2.25 0 017.5 5.25h9a2.25 2.25 0 012.25 2.25v9a2.25 2.25 0 01-2.25-2.25h-9a2.25 2.25 0 01-2.25-2.25v-9z" />
            </svg>
        );
        const UploadIcon = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
            </svg>
        );
        const ExcelIcon = (props) => (<svg viewBox="0 0 24 24" fill="currentColor" {...props}><path d="M21.17 3.25Q21.5 3.25 21.76 3.5 22 3.74 22 4.08V19.92Q22 20.26 21.76 20.5 21.5 20.75 21.17 20.75H7.83Q7.5 20.75 7.24 20.5 7 20.26 7 19.92V17H2.83Q2.5 17 2.24 16.76 2 16.5 2 16.17V7.83Q2 7.5 2.24 7.24 2.5 7 2.83 7H7V4.08Q7 3.74 7.24 3.5 7.5 3.25 7.83 3.25M7 15.13V8.87H4V15.13M12.25 14L10 10.25 12.25 6.5H14.33L11.75 10.25L14.33 14M20 18V6H8.92V18Z" /></svg>);
        const PdfIcon = (props) => (<svg viewBox="0 0 24 24" fill="currentColor" {...props}><path d="M20 2H8C6.9 2 6 2.9 6 4V16C6 17.1 6.9 18 8 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2M11.5 14H10V11H8.5V9.5H11.5M15.5 12.5H13.5V14H12V9.5H15.5C16.3 9.5 17 10.2 17 11C17 11.8 16.3 12.5 15.5 12.5M15.5 11H13.5V11.5H15.5M19.5 14H18V12.5H19.5V11H18V9.5H19.5V8H21V15.5H18V14H19.5M4 6H2V20C2 21.1 2.9 22 4 22H18V20H4Z" /></svg>);
        const TrashIcon = (props) => (<svg fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.124-2.033-2.124H8.033c-1.12 0-2.033.944-2.033 2.124v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>);
        const EditIcon = (props) => (<svg fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>);
        const DeleteIcon = (props) => (<svg fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.124-2.033-2.124H8.033c-1.12 0-2.033.944-2.033 2.124v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>);
        const CheckCircleIcon = (props) => (<svg fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>);
        const ExclamationCircleIcon = (props) => (<svg fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" /></svg>);
        const WarningIcon = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.007H12v-.007z" />
            </svg>
        );
        const SaveIcon = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );
        const CloseIcon = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        );
        const SearchIcon = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
            </svg>
        );

        // --- From components/DashboardCard.tsx ---
        const DashboardCard = ({ icon, value, label, subLabel, color }) => {
            const colorClasses = {
                yellow: { bg: 'bg-yellow-100', text: 'text-yellow-800' },
                green: { bg: 'bg-green-100', text: 'text-green-800' },
                blue: { bg: 'bg-blue-100', text: 'text-blue-800' },
                purple: { bg: 'bg-purple-100', text: 'text-purple-800' },
            };
            const classes = colorClasses[color];

            return (
                <div className={`p-6 rounded-2xl shadow-lg text-center transition-all duration-300 hover:-translate-y-2 hover:shadow-2xl ${classes.bg}`}>
                    <div className="text-5xl mb-4 flex items-center justify-center h-16">
                        {icon}
                    </div>
                    <div>
                        <div className={`text-4xl font-bold ${classes.text}`}>{value}</div>
                        <div className="text-sm text-gray-600 font-semibold tracking-wide">{label}</div>
                        {subLabel && <div className="mt-1">{subLabel}</div>}
                    </div>
                </div>
            );
        };

        // --- From components/AttendanceItem.tsx ---
        const AttendanceItem = ({ record, onEdit, onDelete }) => {
            const recordDate = new Date(record.timestamp).toLocaleDateString();
            const recordTime = new Date(record.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            return (
                <div className="bg-white p-3 rounded-lg shadow-sm border-l-4 border-indigo-500 grid grid-cols-1 md:grid-cols-12 gap-2 items-center">
                    <div className="md:col-span-3 font-semibold text-gray-800 break-all">
                        ID: <span className="font-normal text-gray-600">{record.qrId}</span>
                    </div>
                    <div className="md:col-span-2 text-sm text-gray-500">
                        {recordDate}
                    </div>
                    <div className="md:col-span-2 text-sm text-gray-500">
                        {recordTime}
                    </div>
                    <div className="md:col-span-3 flex items-center gap-2 flex-wrap">
                        {record.egg && (
                            <span className="flex items-center gap-1.5 bg-yellow-100 text-yellow-800 text-sm font-medium px-2.5 py-1 rounded-full">
                                <span className="text-lg" role="img" aria-label="Egg">ü•ö</span>
                                Egg
                            </span>
                        )}
                        {record.banana && (
                            <span className="flex items-center gap-1.5 bg-green-100 text-green-800 text-sm font-medium px-2.5 py-1 rounded-full">
                                <span className="text-lg" role="img" aria-label="Banana">üçå</span>
                                Banana
                            </span>
                        )}
                    </div>
                    <div className="md:col-span-2 flex justify-start md:justify-end gap-2">
                        <button onClick={onEdit} className="p-2 text-green-600 hover:bg-green-100 rounded-full transition-colors" title="Edit">
                            <EditIcon className="w-5 h-5" />
                        </button>
                        <button onClick={() => onDelete(record.id)} className="p-2 text-red-600 hover:bg-red-100 rounded-full transition-colors" title="Delete">
                            <DeleteIcon className="w-5 h-5" />
                        </button>
                    </div>
                </div>
            );
        };

        // --- From components/EditModal.tsx ---
        const EditModal = ({ record, onSave, onClose }) => {
            const [egg, setEgg] = useState(record.egg);
            const [banana, setBanana] = useState(record.banana);

            useEffect(() => {
                const handleKeyDown = (event) => {
                    if (event.key === 'Escape') {
                        onClose();
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [onClose]);

            const handleSave = () => {
                onSave(record.id, egg, banana);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 relative" onClick={(e) => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                            <CloseIcon className="w-6 h-6" />
                        </button>
                        <h2 className="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2"><EditIcon className="w-6 h-6"/>Edit Record</h2>
                        <div className="space-y-2 text-gray-600 mb-6">
                            <p><strong>QR ID:</strong> {record.qrId}</p>
                            <p><strong>Date:</strong> {record.date}</p>
                            <p><strong>Time:</strong> {record.time}</p>
                        </div>
                        <div className="space-y-4 mb-6">
                            <label className="flex items-center gap-4 bg-gray-50 p-4 rounded-lg cursor-pointer">
                                <input type="checkbox" checked={egg} onChange={(e) => setEgg(e.target.checked)} className="h-6 w-6 text-yellow-500 rounded focus:ring-yellow-400 border-gray-300" />
                                <span className="text-3xl" role="img" aria-label="egg">ü•ö</span>
                                <span className="font-semibold text-gray-700 text-lg">Egg</span>
                            </label>
                            <label className="flex items-center gap-4 bg-gray-50 p-4 rounded-lg cursor-pointer">
                                <input type="checkbox" checked={banana} onChange={(e) => setBanana(e.target.checked)} className="h-6 w-6 text-green-500 rounded focus:ring-green-400 border-gray-300" />
                                <span className="text-3xl" role="img" aria-label="banana">üçå</span>
                                <span className="font-semibold text-gray-700 text-lg">Banana</span>
                            </label>
                        </div>
                        <div className="flex justify-end gap-3">
                            <button onClick={onClose} className="btn-secondary">Cancel</button>
                            <button onClick={handleSave} className="btn-primary"><SaveIcon className="w-5 h-5"/>Save Changes</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- From components/ConfirmModal.tsx ---
        const ConfirmModal = ({ isOpen, onClose, onConfirm, title, children }) => {
            useEffect(() => {
                const handleKeyDown = (event) => {
                    if (event.key === 'Escape') {
                        onClose();
                    }
                };
                if (isOpen) {
                    window.addEventListener('keydown', handleKeyDown);
                }
                return () => {
                    window.removeEventListener('keydown', handleKeyDown);
                };
            }, [isOpen, onClose]);

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 relative" onClick={(e) => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                            <CloseIcon className="w-6 h-6" />
                        </button>
                        <div className="sm:flex sm:items-start">
                            <div className="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                                <WarningIcon className="h-6 w-6 text-red-600" aria-hidden="true" />
                            </div>
                            <div className="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                                <h3 className="text-lg leading-6 font-medium text-gray-900" id="modal-title">{title}</h3>
                                <div className="mt-2"><p className="text-sm text-gray-500">{children}</p></div>
                            </div>
                        </div>
                        <div className="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                            <button type="button" className="btn-danger w-full sm:w-auto sm:ml-3" onClick={onConfirm}>Confirm & Delete</button>
                            <button type="button" className="btn-secondary mt-3 w-full sm:mt-0 sm:w-auto" onClick={onClose}>Cancel</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- From components/DatePicker.tsx ---
        const DatePicker = ({ value, onChange, onReset }) => {
            const handleFromChange = (e) => onChange({ ...value, from: e.target.value || null });
            const handleToChange = (e) => onChange({ ...value, to: e.target.value || null });

            return (
                <div className="flex items-center gap-2 flex-wrap">
                    <div className="flex items-center gap-1">
                        <label htmlFor="fromDate" className="text-sm font-medium text-gray-500">From</label>
                        <input id="fromDate" type="date" value={value.from || ''} onChange={handleFromChange} className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm" style={{maxWidth: '150px'}} />
                    </div>
                    <div className="flex items-center gap-1">
                        <label htmlFor="toDate" className="text-sm font-medium text-gray-500">To</label>
                        <input id="toDate" type="date" value={value.to || ''} onChange={handleToChange} className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm" style={{maxWidth: '150px'}} />
                    </div>
                    <button onClick={onReset} className="p-2 text-gray-500 hover:bg-gray-200 rounded-full transition-colors" title="Reset Dates">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5">
                            <path strokeLinecap="round" strokeLinejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.664 0l3.181-3.183m-4.991-2.691V5.006h-4.992v4.992h4.992z" />
                        </svg>
                    </button>
                </div>
            );
        };

        // --- Main App Component (from App.tsx) ---
        const App = () => {
            const [attendanceData, setAttendanceData] = useState([]);
            const [currentQRData, setCurrentQRData] = useState(null);
            const [message, setMessage] = useState(null);
            const [isScanning, setIsScanning] = useState(false);
            const [showSelection, setShowSelection] = useState(false);
            const [editingRecord, setEditingRecord] = useState(null);
            const [cameras, setCameras] = useState([]);
            const [selectedCameraId, setSelectedCameraId] = useState('');
            const [searchQuery, setSearchQuery] = useState('');
            const [dateRange, setDateRange] = useState({ from: null, to: null });
            const [isClearConfirmVisible, setIsClearConfirmVisible] = useState(false);
            const [recordToDelete, setRecordToDelete] = useState(null);

            const html5QrCodeRef = useRef(null);
            const fileInputRef = useRef(null);
            const audioContext = useRef(typeof window !== 'undefined' ? new (window.AudioContext || window.webkitAudioContext)() : null);

            useEffect(() => {
                try {
                    const storedValue = localStorage.getItem('attendanceData');
                    if (storedValue) setAttendanceData(JSON.parse(storedValue));
                } catch (error) { console.error('Error reading from localStorage:', error); }
            }, []);

            useEffect(() => {
                try {
                    localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
                } catch (error) { console.error('Error writing to localStorage:', error); }
            }, [attendanceData]);

            const showMessage = (text, type) => {
                setMessage({ text, type });
                setTimeout(() => setMessage(null), 5000);
            };
            
            const loadCameras = useCallback(async () => {
                try {
                    const devices = await Html5Qrcode.getCameras();
                    if (!devices || devices.length === 0) {
                        setCameras([]);
                        return;
                    }

                    const processedCameras = devices.map((device, index) => {
                        let label = device.label || `Camera ${index + 1}`;
                        if (/(back|rear|environment)/i.test(label)) {
                            label = `üì∑ Back Camera`;
                        } else if (/(front|user|face)/i.test(label)) {
                            label = `ü§≥ Front Camera`;
                        }
                        return { ...device, processedLabel: label };
                    });

                    setCameras(processedCameras);
                    
                    if (!selectedCameraId) {
                         const backCamera = processedCameras.find(d => /(back|rear|environment)/i.test(d.label));
                         setSelectedCameraId(backCamera ? backCamera.id : processedCameras[0].id);
                    }
                } catch (err) {
                    setCameras([]);
                    // Don't show an error on initial load, only when user tries to scan.
                }
            }, [selectedCameraId]);

            useEffect(() => {
                loadCameras();
            }, [loadCameras]);
            
            const playSuccessSound = () => {
                if (!audioContext.current) return;
                const oscillator = audioContext.current.createOscillator();
                const gainNode = audioContext.current.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.current.destination);
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(600, audioContext.current.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioContext.current.currentTime);
                oscillator.start(audioContext.current.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.00001, audioContext.current.currentTime + 0.15);
                oscillator.stop(audioContext.current.currentTime + 0.15);
            };

            const stopScan = useCallback(() => {
                if (html5QrCodeRef.current && html5QrCodeRef.current.isScanning) {
                    html5QrCodeRef.current.stop()
                        .then(() => setIsScanning(false))
                        .catch(err => {
                            console.error("Failed to stop scanning.", err);
                            setIsScanning(false); // Force state update
                        });
                } else {
                     setIsScanning(false);
                }
            }, []);

            const onScanSuccess = useCallback((decodedText) => {
                playSuccessSound();
                stopScan();
                setCurrentQRData(decodedText);
                
                const today = new Date().toDateString();
                const alreadyMarked = attendanceData.some(
                    record => record.qrId === decodedText && new Date(record.timestamp).toDateString() === today
                );

                if (alreadyMarked) {
                    showMessage('Attendance already marked for today!', 'error');
                    setShowSelection(false);
                } else {
                    showMessage(`QR Scanned: ${decodedText}. Please select an item.`, 'success');
                    setShowSelection(true);
                }
            }, [attendanceData, stopScan]);

            const startWebcamScan = async () => {
                if (isScanning) {
                    stopScan();
                    return;
                }

                // Step 1: Explicitly request permission to unblock device enumeration.
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    // Immediately stop the stream; we only needed it to trigger the permission prompt.
                    stream.getTracks().forEach(track => track.stop());
                } catch (err) {
                    console.error("Camera permission was denied:", err);
                    showMessage("Camera permission is required to scan. Please allow access and try again.", 'error');
                    return;
                }

                // Step 2: Now that permission is granted, reload the camera list.
                await loadCameras();
                
                // Step 3: Determine which camera to use.
                let cameraIdToUse = selectedCameraId;
                if (!cameraIdToUse && cameras.length > 0) {
                     const backCamera = cameras.find(d => /(back|rear|environment)/i.test(d.label));
                     cameraIdToUse = backCamera ? backCamera.id : cameras[0].id;
                     setSelectedCameraId(cameraIdToUse);
                }

                if (!cameraIdToUse) {
                    showMessage("No cameras found. Please ensure your device has a camera and permission is granted.", 'error');
                    return;
                }

                // Step 4: Start the scanner.
                stopScan(); // Ensure any previous instance is stopped.
                
                html5QrCodeRef.current = new Html5Qrcode('qr-reader');
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                
                try {
                    await html5QrCodeRef.current.start(cameraIdToUse, config, onScanSuccess, (errorMessage) => { /* Ignore non-success messages */ });
                    setIsScanning(true);
                } catch (err) {
                    console.error("Failed to start scanner:", err);
                    showMessage(`Failed to start camera. It might be in use by another app. Error: ${err.name}`, 'error');
                    setIsScanning(false);
                }
            };


            const handleFileScan = useCallback((event) => {
                const file = event.target.files?.[0];
                if (!file) return;
                stopScan();
                if (!html5QrCodeRef.current) html5QrCodeRef.current = new Html5Qrcode('qr-reader');
                html5QrCodeRef.current.scanFile(file, true)
                    .then(onScanSuccess)
                    .catch(() => showMessage('No QR code found in the image.', 'error'));
                if(fileInputRef.current) fileInputRef.current.value = "";
            }, [onScanSuccess, stopScan]);

            const handleSaveAttendance = (egg, banana) => {
                if (!currentQRData) return;
                const newRecord = {
                    id: Date.now(),
                    qrId: currentQRData,
                    timestamp: new Date().toISOString(),
                    egg,
                    banana,
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString(),
                };
                setAttendanceData(prevData => [...prevData, newRecord]);
                showMessage('Attendance saved successfully!', 'success');
                setTimeout(() => {
                    setShowSelection(false);
                    setCurrentQRData(null);
                }, 2000);
            };
            
            const requestDeleteRecord = (id) => {
                const record = attendanceData.find(r => r.id === id);
                if (record) setRecordToDelete(record);
            };
            
            const handleSaveEdit = (id, egg, banana) => {
                setAttendanceData(prevData => prevData.map(record => record.id === id ? { ...record, egg, banana } : record));
                setEditingRecord(null);
                showMessage('Record updated successfully!', 'success');
            };
            
            const requestClearAllData = () => setIsClearConfirmVisible(true);

            const dashboardStats = useMemo(() => {
                const today = new Date().toDateString();
                return {
                    totalEggs: attendanceData.filter(r => r.egg).length,
                    totalBananas: attendanceData.filter(r => r.banana).length,
                    totalAttendance: attendanceData.length,
                    todayAttendance: attendanceData.filter(r => new Date(r.timestamp).toDateString() === today).length,
                };
            }, [attendanceData]);

            const downloadExcel = useCallback(() => {
                if (attendanceData.length === 0) return showMessage('No data to export.', 'error');
                const wsData = [['ID', 'QR Code', 'Date', 'Time', 'Egg', 'Banana'], ...attendanceData.map(r => [r.id, r.qrId, r.date, r.time, r.egg ? 'Yes' : 'No', r.banana ? 'Yes' : 'No'])];
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Attendance');
                XLSX.writeFile(wb, `Attendance_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
            }, [attendanceData]);

            const downloadPDF = useCallback(() => {
                if (attendanceData.length === 0) return showMessage('No data to export.', 'error');
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text('QR Attendance Report', 105, 20, { align: 'center' });
                doc.autoTable({
                    head: [['QR ID', 'Date', 'Time', 'Egg', 'Banana']],
                    body: attendanceData.map(r => [r.qrId, r.date, r.time, r.egg ? 'ü•ö' : '', r.banana ? 'üçå' : '']),
                    startY: 30,
                });
                doc.save(`Attendance_Report_${new Date().toISOString().split('T')[0]}.pdf`);
            }, [attendanceData]);

            const filteredAndSortedData = useMemo(() => {
                const fromDate = dateRange.from ? new Date(dateRange.from) : null;
                const toDate = dateRange.to ? new Date(dateRange.to) : null;
                if (fromDate) fromDate.setHours(0, 0, 0, 0);
                if (toDate) toDate.setHours(23, 59, 59, 999);
                const filtered = attendanceData.filter(record => {
                    const recordDate = new Date(record.timestamp);
                    const matchesSearch = record.qrId.toLowerCase().includes(searchQuery.toLowerCase());
                    const isAfterFrom = fromDate ? recordDate >= fromDate : true;
                    const isBeforeTo = toDate ? recordDate <= toDate : true;
                    return matchesSearch && isAfterFrom && isBeforeTo;
                });
                return filtered.sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());
            }, [attendanceData, searchQuery, dateRange]);

            return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-500 to-purple-600 p-2 sm:p-4 md:p-8 font-sans">
                    <main className="max-w-7xl mx-auto bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-4 sm:p-6 md:p-8">
                        <header className="text-center mb-8">
                            <h1 className="text-4xl md:text-5xl font-bold bg-gradient-to-r from-indigo-600 to-purple-700 text-transparent bg-clip-text flex items-center justify-center gap-4">
                                <QrCodeIcon className="w-10 h-10" />
                                QR Attendance System
                            </h1>
                            <p className="text-gray-500 mt-2">with Egg & Banana Tracking</p>
                        </header>
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            <section className="bg-indigo-50 border-2 border-dashed border-indigo-300 rounded-xl p-6">
                                <h2 className="text-2xl font-bold text-indigo-800 mb-4 flex items-center gap-2"><CameraIcon className="w-7 h-7" />Scan QR Code</h2>
                                <div className="flex flex-col sm:flex-row gap-4 mb-4">
                                    <select id="cameraSelect" value={selectedCameraId} onChange={(e) => setSelectedCameraId(e.target.value)} className="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" disabled={isScanning}>
                                        {cameras.length > 0 ? cameras.map(cam => (
                                            <option key={cam.id} value={cam.id}>{cam.processedLabel || cam.label}</option>
                                        )) : <option>No cameras found</option>}
                                    </select>
                                </div>
                                <div className="flex flex-wrap gap-3">
                                    {!isScanning ? (
                                        <button onClick={startWebcamScan} className="flex-1 btn-primary"><CameraIcon className="w-5 h-5"/>Start Scan</button>
                                    ) : (
                                        <button onClick={stopScan} className="flex-1 btn-danger"><StopIcon className="w-5 h-5"/>Stop Scan</button>
                                    )}
                                    <input type="file" ref={fileInputRef} accept="image/*" className="hidden" onChange={handleFileScan} />
                                    <button onClick={() => fileInputRef.current?.click()} className="flex-1 btn-secondary"><UploadIcon className="w-5 h-5"/>Upload Image</button>
                                </div>
                                <div id="qr-reader" className="mt-4 rounded-lg overflow-hidden w-full max-w-sm mx-auto aspect-square bg-gray-200"></div>
                            </section>
                            <div className="flex flex-col gap-8">
                                {message && (
                                    <div className={`p-4 rounded-lg flex items-start gap-3 ${message.type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                        {message.type === 'success' ? <CheckCircleIcon className="w-6 h-6 flex-shrink-0" /> : <ExclamationCircleIcon className="w-6 h-6 flex-shrink-0" />}
                                        <span>{message.text}</span>
                                    </div>
                                )}
                                {showSelection && <SelectionComponent onSave={handleSaveAttendance} />}
                            </div>
                        </div>
                        <section className="mb-8">
                            <h2 className="text-2xl font-bold text-gray-700 mb-4">Dashboard</h2>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <DashboardCard icon="ü•ö" value={dashboardStats.totalEggs} label="Total Eggs" color="yellow" />
                                <DashboardCard icon="üçå" value={dashboardStats.totalBananas} label="Total Bananas" color="green" />
                                <DashboardCard icon="üë•" value={dashboardStats.totalAttendance} label="Total Attendance" color="blue" />
                                <DashboardCard icon="üóìÔ∏è" value={dashboardStats.todayAttendance} label="Today's Attendance" subLabel={<span className="block text-xl font-bold mt-1 text-purple-700">{new Date().toLocaleDateString(undefined, { month: 'long', day: 'numeric' })}</span>} color="purple" />
                            </div>
                        </section>
                        <section>
                            <div className="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                                <h2 className="text-2xl font-bold text-gray-700 whitespace-nowrap">Attendance Records</h2>
                                <div className="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 w-full">
                                    <div className="relative w-full sm:flex-grow">
                                        <SearchIcon className="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none" />
                                        <input type="text" placeholder="Search by QR ID..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
                                    </div>
                                    <DatePicker value={dateRange} onChange={setDateRange} onReset={() => setDateRange({ from: null, to: null })} />
                                    <div className="flex flex-wrap gap-2 justify-start">
                                        <button onClick={downloadExcel} className="btn-secondary text-sm"><ExcelIcon className="w-5 h-5" />Excel</button>
                                        <button onClick={downloadPDF} className="btn-secondary text-sm"><PdfIcon className="w-5 h-5" />PDF</button>
                                        <button onClick={requestClearAllData} className="btn-danger text-sm"><TrashIcon className="w-5 h-5" />Clear All</button>
                                    </div>
                                </div>
                            </div>
                            <div className="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto shadow-inner">
                                {attendanceData.length > 0 ? (
                                    filteredAndSortedData.length > 0 ? (
                                        <div className="space-y-3">
                                            {filteredAndSortedData.map(record => (
                                                <AttendanceItem key={record.id} record={record} onEdit={() => setEditingRecord(record)} onDelete={requestDeleteRecord} />
                                            ))}
                                        </div>
                                    ) : (
                                        <p className="text-center text-gray-500 py-8">No records match your filters.</p>
                                    )
                                 ) : (
                                    <p className="text-center text-gray-500 py-8">No attendance records yet.</p>
                                )}
                            </div>
                        </section>
                    </main>
                    {editingRecord && <EditModal record={editingRecord} onSave={handleSaveEdit} onClose={() => setEditingRecord(null)} />}
                    {isClearConfirmVisible && (
                        <ConfirmModal isOpen={isClearConfirmVisible} onClose={() => setIsClearConfirmVisible(false)} onConfirm={() => {
                            setAttendanceData([]);
                            showMessage('All data has been cleared.', 'success');
                            setIsClearConfirmVisible(false);
                        }} title="Confirm Clear All Data">
                            Are you sure you want to permanently delete all attendance records? This action cannot be undone.
                        </ConfirmModal>
                    )}
                    {recordToDelete && (
                        <ConfirmModal isOpen={!!recordToDelete} onClose={() => setRecordToDelete(null)} onConfirm={() => {
                            setAttendanceData(prevData => prevData.filter(record => record.id !== recordToDelete.id));
                            showMessage('Record deleted.', 'success');
                            setRecordToDelete(null);
                        }} title="Confirm Deletion">
                            <>Are you sure you want to delete the record for QR ID: <strong className="font-bold text-gray-800">{recordToDelete.qrId}</strong> on {recordToDelete.date}? This action cannot be undone.</>
                        </ConfirmModal>
                    )}
                </div>
            );
        };
        
        const SelectionComponent = ({ onSave }) => {
            return (
                <section className="bg-gradient-to-br from-yellow-100 to-orange-200 rounded-xl p-6 shadow-lg">
                    <h3 className="text-2xl font-bold text-orange-800 mb-2">Choose One Item</h3>
                    <p className="text-orange-700 mb-4 text-sm">Attendance will save automatically upon selection.</p>
                    <div className="space-y-4">
                        <button onClick={() => onSave(true, false)} className="w-full text-left flex items-center gap-4 bg-white p-4 rounded-lg shadow-md cursor-pointer transition-transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                            <span className="text-4xl" role="img" aria-label="egg">ü•ö</span>
                            <span className="font-semibold text-gray-700 text-lg">Egg</span>
                        </button>
                        <button onClick={() => onSave(false, true)} className="w-full text-left flex items-center gap-4 bg-white p-4 rounded-lg shadow-md cursor-pointer transition-transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500">
                            <span className="text-4xl" role="img" aria-label="banana">üçå</span>
                            <span className="font-semibold text-gray-700 text-lg">Banana</span>
                        </button>
                    </div>
                </section>
            );
        };
        
        // --- Render the App ---
        const rootElement = document.getElementById('root');
        const root = ReactDOM.createRoot(rootElement);
        root.render(<App />);

    </script>
</body>
</html>
